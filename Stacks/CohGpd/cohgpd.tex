\documentclass[a4paper,11pt]{amsart}

\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{lmodern}
\usepackage{microtype}
\usepackage[english]{babel}
\usepackage{geometry}
\usepackage{enumitem}
\usepackage{xcolor}

\usepackage{tikz-cd}
\usepackage{tikz}
\usetikzlibrary{babel}
\usetikzlibrary{decorations.pathmorphing}
\usepackage{amsmath}
\usepackage{amsthm}
\usepackage{amssymb,stmaryrd,mathrsfs}
\usepackage{mathtools}
\usepackage{bm,bbm}

\usepackage{hyperref}
\hypersetup{colorlinks=true,citecolor=teal,linkcolor=blue}
\usepackage[capitalise]{cleveref}

\input{cohgpd-macros}

\geometry{hmargin=2cm,vmargin=2.5cm}

\title{Coherent groupoids (Modified version)}
\author{Steve Awodey}
%\address{Carnegie Mellon University}
\author{Jacopo Emmenegger}
%\address{Università di Genova}
\author{Giuseppe Rosolini}
%\address{Università di Genova}
\date{\today}

\newcommand{\covers}{\twoheadrightarrow}
%{\, \mbox{\large$\rightarrowtriangle$}\, }
% kernal pair of (d,c) for an internal groupoid #1
\newcommand{\kpdcincat}[1]{\argpdf{#1}\hspace{-2ex}\underset{\mbox{\tiny$\obgpdf{#1}\!\!\times\!\!\obgpdf{#1}$}}{\times}\hspace{-2ex}\argpdf{#1}}
\newcommand{\Akpdcin}{\kpdcincat{A}}
\newcommand{\Bkpdcin}{\kpdcincat{B}}
\newcommand{\Ckpdcin}{\kpdcincat{C}}
% squares
\newcommand{\sqincat}[1]{\mathrm{Sq}_{#1}}
\newcommand{\Asqin}{\sqincat{\Agpdf}}
\newcommand{\Bsqin}{\sqincat{\Bgpdf}}
\newcommand{\Csqin}{\sqincat{\Cgpdf}}
\newcommand{\lsqin}[1]{\mathsf{l}_{#1}}
\newcommand{\rsqin}[1]{\mathsf{r}_{#1}}
\newcommand{\tsqin}[1]{\mathsf{t}_{#1}}
\newcommand{\bsqin}[1]{\mathsf{b}_{#1}}
\newcommand{\Alsqin}{\lsqin{\Agpdf}}
\newcommand{\Blsqin}{\lsqin{\Bgpdf}}
\newcommand{\Clsqin}{\lsqin{\Cgpdf}}
\newcommand{\Arsqin}{\rsqin{\Agpdf}}
\newcommand{\Brsqin}{\rsqin{\Bgpdf}}
\newcommand{\Crsqin}{\rsqin{\Cgpdf}}
\newcommand{\Atsqin}{\tsqin{\Agpdf}}
\newcommand{\Btsqin}{\tsqin{\Bgpdf}}
\newcommand{\Ctsqin}{\tsqin{\Cgpdf}}
\newcommand{\Absqin}{\bsqin{\Agpdf}}
\newcommand{\Bbsqin}{\bsqin{\Bgpdf}}
\newcommand{\Cbsqin}{\bsqin{\Cgpdf}}
% commutative squares
\newcommand{\csqincat}[1]{\mathrm{CSq}_{#1}}
\newcommand{\Acsqin}{\csqincat{\Agpdf}}
\newcommand{\Bcsqin}{\csqincat{\Bgpdf}}
\newcommand{\Ccsqin}{\csqincat{\Cgpdf}}
\newcommand{\lcsqin}[1]{\mathsf{l}_{#1}}
\newcommand{\rcsqin}[1]{\mathsf{r}_{#1}}
\newcommand{\tcsqin}[1]{\mathsf{t}_{#1}}
\newcommand{\bcsqin}[1]{\mathsf{b}_{#1}}
\newcommand{\Alcsqin}{\lcsqin{\Agpdf}}
\newcommand{\Blcsqin}{\lcsqin{\Bgpdf}}
\newcommand{\Clcsqin}{\lcsqin{\Cgpdf}}
\newcommand{\Arcsqin}{\rcsqin{\Agpdf}}
\newcommand{\Brcsqin}{\rcsqin{\Bgpdf}}
\newcommand{\Crcsqin}{\rcsqin{\Cgpdf}}
\newcommand{\Atcsqin}{\tcsqin{\Agpdf}}
\newcommand{\Btcsqin}{\tcsqin{\Bgpdf}}
\newcommand{\Ctcsqin}{\tcsqin{\Cgpdf}}
\newcommand{\Abcsqin}{\bcsqin{\Agpdf}}
\newcommand{\Bbcsqin}{\bcsqin{\Bgpdf}}
\newcommand{\Cbcsqin}{\bcsqin{\Cgpdf}}
% groupoid of arrows
\newcommand{\arrgpdin}{^{\!\to}}
% comma category
\newcommand{\cmmcatincat}[2]{#1 \downarrow #2}
\newcommand{\domcommin}[2]{\domincat{\cmmcatincat{#1}{#2}}}
\newcommand{\codcommin}[2]{\codincat{\cmmcatincat{#1}{#2}}}
\newcommand{\fgcmmcatin}{\cmmcatincat{f\hspace{-.5ex}}{\hspace{-.2ex}g}}
\newcommand{\fgobcmmin}{\obgpdf{(\fgcmmcatin)}}
\newcommand{\fgarcmmin}{\argpdf{(\fgcmmcatin)}}
\newcommand{\fgdomcomm}{\domcommin{f\!}{g}}
\newcommand{\fgcodcomm}{\codcommin{f\!}{g}}

\newcommand{\Cc}{\mathbb{C}}
\newcommand{\EE}{\mathcal{E}}

\begin{document}
	\maketitle


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Compact and coherent objects}
\label{sec:comp-coh}

%Let $\Ccat$ be a category with finite limits and $\Ecat$ the topos of sheaves on $\Ccat$ for a Grothendieck topology $\mathcal{J}$.
%An object $A$ of $\Ecat$ is \define{compact} if it is covered by a representable:
%$\yo X \covers A$.
%An arrow $f\colon A\to B$ is \define{compact} if $B$ is a compact object
%and the (vertex of the) pullback of $f$ along (one or all) $b\colon \yo Y \covers B$ is a compact object.

Let $\Cc$ be a category with finite limits and $\EE = [\Cc^{\mathsf{op}}, \mathsf{Set}]$ the topos of presheaves on $\Cc$.  Call an object $K$ of $\EE$ \define{compact} (Johnstone: \emph{supercompact}) if it is covered by a representable,
$\yo c \covers K$.
Call an arrow $f\colon A\to B$ \define{compact} if, for every compact $K$ and arrow $K \to B$, the pullback object $K\times_B A$ is compact.   Note that an object is compact if and only if its terminal projection is compact, and compact objects are closed under finite products.  The following is also easily shown.
% if and only if its identity arrow is compact.

%Note that an arrow that is compact as an object in $\Ecat^\arrcat$
%(\ie~the codomain of a square with a pair of regular epis from a represented arrow)
%is not necessarily a compact arrow in $\Ecat$:
%an arrow $f$ is compact if and only if fits in a square of that form such that, moreover, the canonical arrow into the pullback is a regular epi.
%These are called \define{covering squares}.
%If $\yo k$ is the represented arrow appearing in a covering square of $f$, we say that $k$ \define{covers} $f$.
%
%a regular epi from a represented arrow in the category of arrows $\Ecat^2$ is not necessarily a covering square: the two components are regular epis, but the canonical arrow into the pullback is not necessarily.
%Let $f\colon A\to B$ be a compact arrow, let $b\colon\yo Y\covers B$ and write $X$ for an object covering the pullback of $f$ along $b$.
%We obtain $a\colon \yo X\covers A$ and $k\colon X\to Y$ such that $b\arcmp \yo k = f\arcmp a$ and the canonical arrow into the pullback is a regular epi.
%We say that \define{$k$ covers $f$} if it is obtained in this way,
%and we refer to the square involving $f$ and $k$ as a \define{covering square}.
%Note that a regular epi from a represented arrow in the category of arrows $\Ecat^2$ is not necessarily a covering square: the two components are regular epis, but the canonical arrow into the pullback is not necessarily.

\begin{lem}\label{lem:compact-closure}
	The compact arrows include all isomorphisms and are closed under composition and pullback along arbitrary maps.  
\end{lem}

%\begin{lem}\label{lem:compact-pb}
%	Compact arrows are stable under pullback from compact objects.
%	(Covering squares are stable under pullback from compact objects.)
%	
%	In particular, product projections from a product of compact objects are compact arrows.
%\end{lem}
%
%\begin{proof}
%	Need to show that $g^*f$ is compact.
%	\[\begin{tikzcd}[column sep=5ex, row sep=3ex]
%		\yo(Z\times_YX)	\ar[ddd,bend right=9ex] \ar[d,two heads] \ar[rr]
%		&&	\yo X \ar[ddd,bend right=9ex] \ar[d,two heads]
%		&[3ex]\\
%		\bullet	\ar[dd] \ar[dr,two heads] \ar[rr,crossing over]	&&	\bullet	\ar[dd] \ar[dr,two heads]
%		&\\
%		&	g^*A	\ar[rr,crossing over]	&&	A	\ar[dd,"f"{near end}]
%		\\
%		\yo Z	\ar[dr, two heads] \ar[rr]	&&	\yo Y	\ar[dr, two heads]
%		&\\
%		&	C	\ar[from=uu,"g^*f"{near end},crossing over] \ar[rr,"g"']	&&	B
%	\end{tikzcd}\]
%	Left- and right-hand faces of the cube are pullback, so the back face is a pullback, and so is the square on top.
%\end{proof}
%
%\begin{rmk}\label{rmk:compact-pb}
%Two immediate consequences of \cref{lem:compact-closure}.
%\begin{enumerate}
%	\item\label{rmk:compact-pb:ker}
%	If $f\colon A\to B$ is compact, then	each leg of its kernel pair $f_1,f_2\colon A\times_BA \rightrightarrows A$ is compact.
%	In particular, the object $A\times_B A$ is compact.
%	\item\label{rmk:compact-pb:mix}
%	Given compact arrows $f\colon A\to C\times D$ and $g\colon B\to D\times E$,
%	consider the pullback $A\times_DB$ of $f_2$ and $g_1$ and write $p_1, p_2$ for the two legs and $p$ for the diagonal.
%	If the object $C\times D\times E$ is compact,
%	the arrow $\ple{f_1\arcmp p_1,p,g_2\arcmp p_2}\colon A\times_D B \to C\times D\times E$ is compact since it fits in the pullback below.
%	\[\begin{tikzcd}[column sep=9ex,row sep=5ex]
%		A\times_DB	\ar[d,"{\ple{f_1\arcmp p_1,p,g_2\arcmp p_2}}"'] \ar[r,hook]	&	A\times B	\ar[d,"f\times g"]
%		\\
%		C\times D\times E	\ar[r,"{\pr{1,2,2,3}}",hook]	&	C\times D\times D\times E
%	\end{tikzcd}\]
%	
%	If moreover the objects $D$ and $C\times E$ are compact,
%	the arrow $f_1\times g_2\colon A\times_DB\to C\times E$ is compact too by \cref{lem:compact-closure}.
%\end{enumerate}
%\end{rmk}

Let $K$ be compact, with cover $\yo c \covers K$, and suppose that the diagonal map $\Delta_K:K\to K\times K$ is also compact.  Then the evident pullback $K' \rightarrowtail \yo c \times \yo c$ of $\Delta_K$ to $\yo c \times \yo c$ is also compact, and $K'$ is therefore a compact object, with cover $\yo c' \covers K'$.
\[\begin{tikzcd}[column sep=9ex,row sep=5ex]
		\yo c' \ar[rd] \ar[r,twoheadrightarrow] & K'	\ar[d] \ar[r,twoheadrightarrow]	&	K \ar[d,"\Delta_K"]
		\\
		&\yo c \times \yo c	\ar[r,twoheadrightarrow]	&	K \times K
	\end{tikzcd}\]
 It follows that K is a coequalizer of representables, $\yo c' \rightrightarrows \yo c \covers K$, and that $c' \rightrightarrows c$ is, moreover, a pseudo-equivalence relation (in the sense of \cite{Carboni}) in $\Cc$.  This motivates the following.

\begin{defn} An object  $C$ in $\EE$ is called \define{coherent} if it is compact and the diagonal $\Delta_C \colon C\to C\times C$ is a compact map.
\end{defn}

\begin{lem}\label{lem:coherent-cartesian}
	\begin{enumerate} \item A coherent object $C$ is the coequalizer of a pseudo-equivalence relation of representables $\yo c' \rightrightarrows \yo c \covers C$.  \item Moreover, the coherent objects are closed under finite limits.\end{enumerate}
\end{lem}

\begin{proof}
We just showed the first statement, except for the pseudo-equivalence relation part.  For that, observe that $K'\rightarrowtail \yo c \times\yo c$ in the previous displayed diagram is an actual equivalence relation with a projective cover $\yo c' \covers K'$, so there are maps $\rho : \yo c \to \yo c'$ and $\sigma : \yo c' \to \yo c'$ witnessing reflexivity and symmetry, as well as $\tau : \yo c' \times_{\yo c} \yo c' \to \yo c'$ for transitivity.  It follows that $c' \rightrightarrows c$ is also a pseudo-equivalence relation in $\Cc$, as stated above.

The terminal object $1=\yo 1$ is clearly coherent.  For closure under products, let $A, B$ be coherent, therefore compact, so $A\times B$ is compact.  The diagonal $\Delta_{A\times B} : A\times B \to (A\times B) \times (A\times B) \cong (A\times A) \times (B\times B)$ is isomorphic to $\Delta_A\times \Delta_B$, and therefore also compact, since the product of compact maps is easily seen to be compact, using Lemma \ref{lem:compact-closure}.  Let $f, g : C \rightrightarrows C'$ with $C, C'$ coherent.  The equalizer $E \rightarrowtail C$ is the pullback of the compact map $\Delta_{C'}$ along $\langle f,g\rangle : C \to C'\times C'$, and so $E$ is compact, since $C$ is.  Finally, $\Delta_E$ is the pullback of the compact map $\Delta_C$ along the mono $E\times E \rightarrowtail C\times C$, and is therefore also compact.
%
%		\[\begin{tikzcd}[column sep=5ex, row sep=3ex]
%		\yo(Z\times_YX)	\ar[ddd,bend right=9ex] \ar[d,two heads] \ar[rr]
%		&&	\yo X \ar[ddd,bend right=9ex] \ar[d,two heads]
%		&[3ex]\\
%		\bullet	\ar[dd] \ar[dr,two heads] \ar[rr,crossing over]	&&	\bullet	\ar[dd] \ar[dr,two heads]
%		&\\
%		&	g^*A	\ar[rr,crossing over]	&&	A	\ar[dd,"f"{near end}]
%		\\
%		\yo Z	\ar[dr, two heads] \ar[rr]	&&	\yo Y	\ar[dr, two heads]
%		&\\
%		&	C	\ar[from=uu,"g^*f"{near end},crossing over] \ar[rr,"g"']	&&	B
%	\end{tikzcd}\]
%	Left- and right-hand faces of the cube are pullback, so the back face is a pullback, and so is the square on top.
\end{proof}


%
%An arrow $f\colon A\to B$ is \define{coherent} if it is coherent as an object in $\EE/_B$.
%A compact object $A$ is coherent if and only if the kernel pair of a cover $a\colon \yo X\covers A$ is a compact object:
%\[\begin{tikzcd}
%	\yo \bar{X}	\ar[r,two heads]	&	K_a	\ar[r,shift left=.7ex] \ar[r,shift right=.3ex]	&	\yo X	\ar[r,"a",two heads]	&	A
%\end{tikzcd}\]
%in this case the diagonal on $A$ is covered by $\bar{X}$,
%and $\bar{X}\rightrightarrows X$ is a pseudo equivalence relation.
%
%In general, a subobject of a compact object will not be compact ($K_a$ is compact if and only if $A$ is coherent).
%However, compact subobjects of coherent objects are coherent.
%However, we are rather interested in coherent arrows.
%
%\begin{cor}\label{cor:coher-closure}
%	Coherent arrows contain:
%	\begin{enumerate}
%		\item\label{cor:coher-closure:mono}
%		all compact monic arrows,
%		\item\label{cor:coher-closure:iso}
%		all isomorphisms from compact objects, and
%		\item\label{cor:coher-closure:term}
%		all terminal arrows from coherent objects,
%	\end{enumerate}
%	and are closed under:
%	\begin{enumerate}[resume]
%		\item\label{cor:coher-closure:comp}
%		composition, and
%		\item\label{cor:coher-closure:prod}
%		product (in $\Ecat^2$).
%	\end{enumerate}
%\end{cor}
%
%\begin{proof}
%	(\ref*{cor:coher-closure:mono})
%	Given a mono $m$, its kernel pair and the diagonal into it are identities,
%	thus compact by \cref{lem:compact-closure} whenever the domain of $m$ is a compact object.
%	
%	(\ref*{cor:coher-closure:iso})
%	An iso from a compact object is compact by \cref{lem:compact-closure}
%	and coherent by \eqref{cor:coher-closure:mono} just proved.
%
%	(\ref*{cor:coher-closure:term})
%	Obvious.
%
%	(\ref*{cor:coher-closure:comp})
%	For every composable pair $A\overset{f}{\to}B\overset{g}{\to}C$,
%	the diagonal $A\hookrightarrow A\times_CA$ factors as shown below, where the square is a pullback.
%	\[\begin{tikzcd}[column sep=7ex, row sep=5ex]
%		A	\ar[dr,hook,bend right=3ex] \ar[r,hook]	&[2ex]	A\times_BA	\ar[d,hook] \ar[r]	&	B \ar[d,hook]
%		\\
%		&	A\times_CA	\ar[r,"f\times f"]	&	B\times_CB
%	\end{tikzcd}\]
%	The claim then follows from \cref{lem:compact-closure,lem:compact-pb}.
%	
%	(\ref*{cor:coher-closure:prod})
%	The claim follows from \cref{lem:compact-closure} once we observe that
%	the diagonal into the kernel of $f\times f'\colon A\times A' \to B\times B'$ is the product of the diagonal into the kernel of $f$ with the diagonal into the kernel of $f'$.
%\end{proof}
%
%\begin{cor}\label{cor:coher-pb}
%	Coherent arrows are stable under pullback from compact objects.
%\end{cor}
%
%\begin{proof}
%	$g^*A \times_C g^*A$ is a pullback of $A \times_B A$ along $g$.
%	It follows that $\pr{1,1}\colon g^*A\to g^*A \times_C g^*A$ is a pullback of $\pr{1,1}\colon A\to A\times_BA$.
%	The claim follows from \cref{lem:compact-pb}.
%\end{proof}
%
%\begin{rmk}\label{rmk:coher}
%\hfill
%\begin{enumerate}
%	\item\label{rmk:coher:pbmix}
%	In the situation of \cref{rmk:compact-pb}\eqref{rmk:compact-pb:mix},
%	if the arrows $f$ and $g$ are coherent, then so is the arrow
%	$\ple{f_1\arcmp p_1,p,g_2\arcmp p_2}\colon A\times_DB\to C\times D\times E$.
%	However, the projection to $C\times E$ will only be compact in general (unless the objects involved are coherent).
%	\item\label{rmk:coher:diag}
%	It follows from \cref{cor:coher-closure}\eqref{cor:coher-closure:mono}
%	that the diagonal into the kernel pair of a coherent arrow is also coherent.
%\end{enumerate}
%\end{rmk}
%
%\begin{rmk}\label{rmk:coher-lim}
%	The full subcategory of $\Ecat$ on the compact objects is not closed under finite limits, but the full subcategory on the coherent objects is closed under finite limits:
%	the fact that the vertex $C$ of a cospan is coherent allows us to show that the (vertex of the) pullback of the cospan is compact (and thus coherent because a subobject of a product of coherent objects).
%	
%	In fact, compact objects are closed under finite limits if and if they coincide with coherent objects.
%	This follows from the fact that a compact object $C$ is coherent if and only if every pullback over $C$ of arrows from compact objects is compact.
%	
%	Intuitively, knowing that an object $C$ is coherent allows us to cover objects defined by equations in $C$, \ie~limits of diagrams landing in $C$.
%	In the case of a coherent arrow $f\colon A\to B$, we can cover limits of diagrams ``over $f$'',
%	\eg~pullbacks of cospans with vertex $A$ whose legs are coequalised by $f$.
%	In particular, if $g\colon C\to A$ is from a compact object $C$, then the kernel pair of $g$ is a compact object. (This could be turned into a lemma.)
%\end{rmk}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coherent groupoids}
\label{sec:coh-gpd}

Everything we say in this section holds with groupoids replaced by categories.

A groupoid $\Agpdf=(\Aobgpdf,\Aargpdf,\ldots)$ internal to $\Ecat$ is \define{coherent} if $\ple{\Adomgpdf,\Acodgpdf}\colon \Aargpdf\to \Aobgpdf\times\Aobgpdf$ is coherent.
This means that:
\begin{enumerate}
	\item
	$\Aobgpdf$ is compact,
	\item
	$\ple{\Adomgpdf,\Acodgpdf}\colon \Aargpdf\to \Aobgpdf\times\Aobgpdf$ is compact, and
	\item
	$\pr{1,1}\colon \Aargpdf \mono \Akpdcin$ is compact.
\end{enumerate}

The two legs $\Adomgpdf$ and $\Acodgpdf$ will not be coherent in general.
However, they are always compact
since the two product projections from $\Aobgpdf \times \Aobgpdf$ are compact by \cref{lem:compact-pb}.

We shall be interested in the full sub-2-category $\Echgpdin$ of $\Egpdin$ on the coherent groupoids.
\Cref{rmk:coher-lim} entails that it will not be possible to show in general that $\Echgpdin$ has finite limits:
since the object of objects of a coherent groupoid is not a coherent object,
we should not expect to be able to cover every (finite) limit of coherent groupoids.

On the other hand, $\Echgpdin$ does have certain (2-)limits.

Let us begin considering the object of (not necessarily) commutative squares in an internal groupoid $\Agpdf$.
It can be computed as the pullback on the left below,
\begin{equation}\label{eq:squares}
\begin{tikzcd}[column sep=13ex, row sep=5ex]
	\Asqin	\ar[r,"\ple{\mathsf{l},\mathsf{r}}"] \ar[d,"\ple{\mathsf{t},\mathsf{b}}"']
	&	\Aargpdf\times\Aargpdf	\ar[d,"\ple{\domincat{},\codincat{}}\times\ple{\domincat{},\codincat{}}"]
	\\
	\Aargpdf\times\Aargpdf	\ar[r,"\ple{\domincat{}\times \domincat{},\,\codincat{}\times \codincat{}}"]
	&	A_0\stimes A_0\stimes A_0\stimes A_0
\end{tikzcd}
\hspace{9ex}
\begin{tikzcd}[column sep=7ex, row sep=5ex]
	\Aargpdf \stimes_{\!\Aobgpdf} \Aargpdf	\ar[d,"p_1"'] \ar[r,"p_2"]
	&	\Aargpdf	\ar[d,"\domincat{}"]
	\\
	\Aargpdf	\ar[r,"\codincat{}"]	&	\Aobgpdf
\end{tikzcd}
\end{equation}
where think of the first leg as providing the top and bottom arrows in the square,
and of the second leg as providing the left and right arrows.
The two (non trivial) composable pairs in the square can be obtained as the two arrows into the pullback on the right induced by the pairs $\ple{\mathsf{l},\mathsf{b}}\colon \Asqin\to \Aargpdf \times \Aargpdf$ and $\ple{\mathsf{t},\mathsf{r}}\colon \Asqin\to \Aargpdf \times \Aargpdf$, respectively.
We shall write $\ple{\mathsf{l},\mathsf{b}}$ and $\ple{\mathsf{t},\mathsf{r}}$ for the induced arrows into $\Aargpdf \times_{\Aobgpdf}\Aargpdf$ as well.

\begin{lem}\label{lem:squares}
The two legs $\ple{\mathsf{t},\mathsf{b}}$ and $\ple{\mathsf{l},\mathsf{r}}$ of the pullback~\eqref{eq:squares} that defines $\Asqin$ are coherent.
\end{lem}

\begin{proof}
	This follows from \cref{cor:coher-pb} once we observe that
	$\ple{\domincat{},\codincat{}}\times\ple{\domincat{},\codincat{}}$ is a product of coherent arrows,
	and $\ple{\domincat{}\times \domincat{},\codincat{}\times \codincat{}}$ factors through it via the automorphism
	$\pr{1,3,2,4}$ of $A_0\stimes A_0\stimes A_0\stimes A_0$ (which is a compact object).
\end{proof}
%
%kernel pair of a compact arrow, as shown below.
%\[\begin{tikzcd}[column sep=7ex, row sep=5ex]
%	\Aargpdf \stimes_{\!\Aobgpdf} \Aargpdf	\ar[d,"p_1"'] \ar[r,"p_2"]
%	&	\Aargpdf	\ar[d,"\domincat{}"]
%	\\
%	\Aargpdf	\ar[r,"\codincat{}"]	&	\Aobgpdf
%\end{tikzcd}
%\hspace{9ex}
%\begin{tikzcd}[column sep=13ex, row sep=5ex]
%	\Asqin	\ar[r] \ar[d]	&	\Aargpdf\times_{\!\Aobgpdf} \Aargpdf	\ar[d,"\ple{\domincat{}\arcmp p_1,\codincat{}\arcmp p_2}"]
%	\\
%	\Aargpdf\times_{\!\Aobgpdf} \Aargpdf	\ar[r,"\ple{\domincat{}\arcmp p_1,\codincat{}\arcmp p_2}"]	&	A_0\times A_0
%\end{tikzcd}\]
%The arrow $\ple{\domincat{}\arcmp p_1,\codincat{}\arcmp p_2}$ is compact.

Given an internal groupoid $\Agpdf$,
%the internal groupoid of arrows of $\Agpdf$ can be constructed as follows.
%The object of objects of $\Agpdf^\to$ is $\Aargpdf$, which is compact by assumption.
%The object of arrows of $\Agpdf^\to$ is 
the object of internal commutative squares in $\Acsqin$
is the subobject of $\Asqin$ that fits into the pullback below,
\begin{equation}\label{eq:comm-squares}
\begin{tikzcd}[column sep=19ex, row sep=5ex]
	\Acsqin	\ar[d,"m"',hook] \ar[r]	&	\Aargpdf	\ar[d,"\pr{1,1}",hook]
	\\
	\Asqin	\ar[r,"\ple{\Acmpgpdf \arcmp\ple{\mathsf{l},\mathsf{b}},\, \Acmpgpdf \arcmp\ple{\mathsf{t},\mathsf{r}}}"]
	&	\Akpdcin
\end{tikzcd}
\end{equation}
where the object in the bottom right is the kernel of $\ple{\Adomgpdf,\Acodgpdf}\colon \Aargpdf \to \Aobgpdf \times \Aobgpdf$.
The bottom arrow clearly exists.

The object $\Acsqin$ is the object of arrows of the internal groupoid $\Agpdf\arrgpdin$ of arrows of $\Agpdf$,
and the object of objects is $\Aargpdf$.
For the domain and codomain structure map of $\Agpdf\arrgpdin$ we could pick either of the two arrows below.
\begin{equation}\label{eq:sides}
\begin{tikzcd}[column sep=7ex, row sep=3ex]
	\Acsqin	\ar[dr,"m"',hook] \ar[rr,"\ple{\mathsf{t},\mathsf{b}}"]	&&	\Aargpdf \times \Aargpdf
	\\
	&	\Asqin	\ar[ur,"\ple{\mathsf{t},\mathsf{b}}"']
\end{tikzcd}
\hspace{9ex}
\begin{tikzcd}[column sep=7ex, row sep=3ex]
	\Acsqin	\ar[dr,"m"',hook] \ar[rr,"\ple{\mathsf{l},\mathsf{r}}"]	&&	\Aargpdf \times \Aargpdf
	\\
	&	\Asqin	\ar[ur,"\ple{\mathsf{l},\mathsf{r}}"']
\end{tikzcd}
\end{equation}
The two choices give rise of course to isomorphic groupoids.
We take the leg $\ple{\mathsf{l},\mathsf{r}}$ to be the structure map.
The rest of the structure is induced in the obvious way from that of $\Agpdf$ via the pullbacks in~\eqref{eq:squares} and~\eqref{eq:comm-squares},
or more directly using the fact that the pair of arrows
$\ple{\mathsf{l},\mathsf{b}}\arcmp m,\ple{\mathsf{t},\mathsf{r}}\arcmp m\colon \Acsqin \to \Aargpdf \times_{\!\Aobgpdf}\Aargpdf$
is the kernel pair of the internal composition $\Acmpgpdf\colon \Aargpdf \times_{\!\Aobgpdf}\Aargpdf \to \Aargpdf$.

%	For every internal groupoid $\Agpdf$, we could pick either $\ple{\mathsf{t},\mathsf{b}}$ or $\ple{\mathsf{l},\mathsf{r}}$
%	for the domain and codomain structure map of our internal groupoid of arrows.

\begin{cor}\label{cor:arr-gpd}
	If $\Agpdf$ is a coherent groupoid,
	then its groupoid of arrows $\Agpdf\arrgpdin$ is coherent.
\end{cor}

\begin{proof}
	The diagonal in~\eqref{eq:comm-squares} is compact, and thus coherent by \cref{rmk:coher}\eqref{rmk:coher:diag}.
	Therefore, the arrow $m$ is coherent as well by \cref{cor:coher-pb}.
	It follows from \cref{lem:squares} and \cref{cor:coher-closure}\eqref{cor:coher-closure:comp}
	that the two composites in~\eqref{eq:sides} are both coherent.
	In particular, the groupoid of arrows $\Agpdf^\to$ is coherent.
%	
%	The object of objects of $\Agpdf^\to$ is $\Aargpdf$, which is compact by assumption.
%	The object of arrows of $\Agpdf^\to$ is the object of internal commutative squares $\Acsqin$.
%	It fits into the pullback below
%	\[\begin{tikzcd}[column sep=19ex, row sep=5ex]
%		\Acsqin	\ar[d,"m"',hook] \ar[r]	&	\Aargpdf	\ar[d,"\pr{1,1}",hook]
%		\\
%		\Asqin	\ar[r,"\ple{\Acmpgpdf \arcmp\ple{\mathsf{l},\mathsf{b}}, \Acmpgpdf \arcmp\ple{\mathsf{t},\mathsf{r}}}"]
%		&	\Akpdcin
%	\end{tikzcd}\]
%	where the bottom horizontal arrow takes an internal square to the internal composite of the two composable pairs of arrows,
%	which have the same domain and codomain.
%	The right-hand arrow is coherent by \cref{rmk:coher}\eqref{rmk:coher:diag},
%	therefore $m$ is coherent by \cref{cor:coher-pb}.
%	It follows from \cref{lem:squares} and \cref{cor:coher-closure}\eqref{cor:coher-closure:comp}
%	that the arrows
%	\[\begin{tikzcd}[column sep=7ex, row sep=3ex]
%		\Acsqin	\ar[dr,"m"',hook] \ar[rr,"\ple{\mathsf{t},\mathsf{b}}"]	&&	\Aargpdf \times \Aargpdf
%		\\
%		&	\Asqin	\ar[ur,"\ple{\mathsf{t},\mathsf{b}}"']
%	\end{tikzcd}
%	\hspace{9ex}
%	\begin{tikzcd}[column sep=7ex, row sep=3ex]
%		\Acsqin	\ar[dr,"m"',hook] \ar[rr,"\ple{\mathsf{l},\mathsf{r}}"]	&&	\Aargpdf \times \Aargpdf
%		\\
%		&	\Asqin	\ar[ur,"\ple{\mathsf{l},\mathsf{r}}"']
%	\end{tikzcd}\]
%	are coherent.
%	In particular, the groupoid of arrows $\Agpdf^\to$ is coherent.
%	
%	
%	which can be most straightforwardly be constructed as the kernel pair of the composition arrow
%	$\Acmpgpdf\colon \Aargpdf \times_{\!\Aobgpdf}\Aargpdf \to \Aargpdf$.
%	However this construction does not make explicit the fact that 
%	\[\begin{tikzcd}[column sep=13ex, row sep=5ex]
%		\Acsqin	\ar[d,"s"',hook] \ar[r]	&	\Aargpdf	\ar[d,"\pr{1,1}",hook]
%		\\
%		\Asqin	\ar[r,"\Acmpgpdf\times\Acmpgpdf"]
%		&	\Akpdcin
%	\end{tikzcd}\]
%	
%	
%	kernel pair of the composition in $\Agpdf$,
%	as in the right hand pullback below.
%	The square on the left is also a pullback.
%	
%	\[\begin{tikzcd}
%		\Aargpdf \stimes_{\!\Aobgpdf} \Aargpdf	\ar[d,"p_1"'] \ar[r,"p_2"]
%		&	\Aargpdf	\ar[d,"\domincat{}"]
%		\\
%		\Aargpdf	\ar[r,"\codincat{}"]	&	\Aobgpdf
%	\end{tikzcd}
%	\hspace{9ex}
%	\begin{tikzcd}[column sep=13ex, row sep=5ex]
%		\Acsqin	\ar[d,"s"',hook] \ar[r]	&	\Aargpdf	\ar[d,"\pr{1,1}",hook]
%		\\
%		(\Aargpdf \stimes_{\!\Aobgpdf} \Aargpdf)\stimes (\Aargpdf \stimes_{\!\Aobgpdf} \Aargpdf)	\ar[r,"\Acmpgpdf\times\Acmpgpdf"]
%		&	\Akpdcin
%	\end{tikzcd}\]
%	
%	By definition, the groupoid $\Agpdf^\to$ is coherent if the composite $\ple{\Alcsqin,\Arcsqin}\coloneqq(p_1\times p_2)\arcmp s\colon \Acsqin\to \Aargpdf\times\Aargpdf$ (that picks out the left and right sides of the square) is a coherent arrow.
%	The pullback projections $p_1$ and $p_2$ are compact by \cref{lem:compact-pb},
%	and $s$ is a coherent arrow by \cref{cor:coher-pb}
%	(recall that the diagonal into the kernel of a coherent arrow is coherent).
%	It follows from \cref{cor:coher-closure}\eqref{cor:coher-closure:comp} that $(p_1\times p_2)\arcmp s$ is compact.
%	
%	
%	
%	The product $p_1\times p_2\colon \Big(\Akpdcin\Big)\times\Big(\Akpdcin\Big) \to \Aargpdf\times\Aargpdf$ is coherent by \cref{cor:coher-closure}\eqref{cor:coher-closure:prod},
%	and the arrow $\ple{\Alcsqin,\Arcsqin}$ is then coherent by \cref{cor:coher-closure}\eqref{cor:coher-closure:comp}.
%	
%	\[\begin{tikzcd}[column sep=7ex, row sep=5ex]
%		\Acsqin	\ar[d,"c"'] \ar[r,"c'"]	&	\Akpdcin	\ar[d,"\Acmpgpdf"]
%		\\
%		\Akpdcin	\ar[r,"\Acmpgpdf"]	&	\Aargpdf
%	\end{tikzcd}\]
%	The domain and codomain arrows of the groupoid of arrows are the composites
%	$\domincat{}=p_1 \arcmp c$ and $\codincat{}=p_2\arcmp c'$.
%	We write $\Atcsqin,\Abcsqin\colon \Acsqin \to \Aargpdf$ for the other two components
%	(the top and bottom components of the commutative square).
%	
%	Since all objects involved are compact, and $\ple{\Adomgpdf,\Acodgpdf}$ is coherent by assumption, we can conclude that $\Acsqin$ is compact.
%	However, we still have to show that $\ple{\domincat{},\codincat{}}$ are coherent.
\end{proof}

\begin{prop}\label{prop:comma-objs}
	Let $f\colon\Agpdf\to\Cgpdf$ and $g\colon\Bgpdf\to\Cgpdf$ be functors between coherent groupoids.
	Then the comma groupoid $\fgcmmcatin$ is coherent.
\end{prop}

\begin{proof}
	The objects of objects and of arrows of the comma groupoid $\fgcmmcatin$
	can be constructed taking the pullback squares below.
	\[\begin{tikzcd}[column sep=7ex, row sep=5ex]
		\fgobcmmin	\ar[d,"\ple{\mathsf{l}_0,\mathsf{r}_0}"'] \ar[r,"\mathsf{c}_0"]
		&	\Cargpdf	\ar[d,"\ple{\Cdomgpdf,\Ccodgpdf}"]
		\\
		\Aobgpdf \times \Bobgpdf	\ar[r,"{f_0\times g_0}"]
		&	\Cobgpdf \times \Cobgpdf
	\end{tikzcd}
	\hspace{7ex}
	\begin{tikzcd}[column sep=13ex, row sep=5ex]
		S	\ar[d,"\ple{t,b}"'] \ar[r,"\ple{l,r}"]
		&	\Aargpdf \times \Bargpdf	\ar[d,"\ple{\Adomgpdf,\Acodgpdf}\times \ple{\Bdomgpdf,\Bcodgpdf}"]
		\\
		\fgobcmmin \times \fgobcmmin	\ar[r,"\ple{\mathsf{l}_0 \times \mathsf{l}_0,\,\mathsf{r}_0 \times \mathsf{r}_0}"]
		&	\Aobgpdf \stimes \Aobgpdf \stimes \Bobgpdf \stimes \Bobgpdf
	\end{tikzcd}\]
	
	\vspace{1ex}
	\[\begin{tikzcd}[column sep=19ex, row sep=5ex]
		\fgarcmmin	\ar[d,"m"',hook] \ar[r]	&	\Cargpdf	\ar[d,"\pr{1,1}",hook]
		\\
		S	\ar[r,"\ple{\Ccmpgpdf \arcmp\ple{l,b},\,\Ccmpgpdf \arcmp\ple{t,r}}"]
		&	\Ckpdcin
	\end{tikzcd}\]
	
	We need to show that the arrow $\ple{t,b}\arcmp m\colon \fgarcmmin \to \fgobcmmin \times \fgobcmmin$ is coherent.
	This follows from the following applications of \cref{cor:coher-pb}:
	the arrow $\ple{\mathsf{l}_0,\mathsf{r}_0}$ is coherent, in particular, $\fgobcmmin$ is compact;
	the arrow $\ple{t,b}$ is coherent, in particular $S$ is compact;
	and, finally, the arrow $m$ is coherent.
\end{proof}

\begin{rmk}\label{rmk:comma-objs}
	The arrow $\ple{\mathsf{l}_0 \times \mathsf{l}_0,\,\mathsf{r}_0 \times \mathsf{r}_0}$ is also coherent,
	since it factors through $\ple{\mathsf{l}_0,\mathsf{r}_0}\times \ple{\mathsf{l}_0,\mathsf{r}_0}$ via an automorphism of their codomain.
	Therefore, both legs from $S$ are coherent.
	we shall write
	\[
	\ple{\mathsf{l}_1,\mathsf{r}_1}\coloneqq \ple{l,r}\arcmp m
	\hspace{5ex}\text{and}\hspace{5ex}
	\ple{\fgdomcomm,\fgcodcomm}\coloneqq \ple{t,b}\arcmp m
	\]
	for the corresponding coherent legs from $\fgarcmmin$.
	
	The pairs $(\mathsf{l}_0,\mathsf{l}_1)$ and $(\mathsf{r}_0,\mathsf{r}_1)$ are internal functors from $\fgcmmcatin$ to $\Agpdf$ and $\Bgpdf$, respectively.
\end{rmk}

There is an algebraic weak factorisation system $(\mathsf{L},\mathsf{R})$ on $\Egpdin$ whose algebras are split isofibrations, and whose 2-category of pseudo-algebras and pseudo-morphisms is equivalent to the category of cloven isofibrations (where morphisms simply preserve cartesian arrows).

Given an internal functor $f\colon \Agpdf \to \Bgpdf$, the factorisation of $f$ is taken through an object which can be computed as the comma groupoid $\cmmcatincat{f\hspace{-.5ex}}{\hspace{-.3ex}\idcat{\Bgpdf}}$.
If $\Agpdf$ and $\Bgpdf$ are coherent groupoids,
then so is $\cmmcatincat{f\hspace{-.5ex}}{\hspace{-.3ex}\idcat{\Bgpdf}}$ by \cref{prop:comma-objs}.
We thus have the following.

\begin{prop}
	The awfs $(\mathsf{L},\mathsf{R})$ on $\Egpdin$ restricts to an awfs $(\mathsf{L}',\mathsf{R}')$ on $\Echgpdin$ such that
	\begin{enumerate}
		\item
		the 2-category of algebras of $\mathsf{R}'$ and their pseudo-morphisms is equivalent to the 2-category of split isofibrations between coherent groupoids, and
		\item
		the 2-category of pseudo-algebras of $\mathsf{R}'$ and their pseudo-morphisms is equivalent to the 2-category of cloven isofibrations between coherent groupoids.
	\end{enumerate}
\end{prop}

Or rather, internally it makes sense to define the 2-category of internal (split) isofibrations between coherent groupoids as the 2-category of (strict) algebras and pseudo morphisms $\catof{Alg}(\mathsf{R'})$.
This is fibred over $\Echgpdin$, and the fibration is the one that supports the Hofmann--Streicher groupoid model.
\end{document}
